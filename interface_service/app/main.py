import streamlit as st
import requests
import json

# --- Page Configuration ---
st.set_page_config(
    page_title="Lviv City Pulse",
    page_icon="üèôÔ∏è",
    layout="wide"
)

# --- Constants ---
PREDICT_API_URL = "http://model-api:8000/predict"
ACTUAL_API_URL = "http://model-api:8000/actual"

# CRUCIAL FIX: Ensure district names match the database exactly
DISTRICTS = [
    "–ì–∞–ª–∏—Ü—å–∫–∏–π —Ä–∞–π–æ–Ω", 
    "–ó–∞–ª—ñ–∑–Ω–∏—á–Ω–∏–π —Ä–∞–π–æ–Ω", 
    "–õ–∏—á–∞–∫—ñ–≤—Å—å–∫–∏–π —Ä–∞–π–æ–Ω", 
    "–°–∏—Ö—ñ–≤—Å—å–∫–∏–π —Ä–∞–π–æ–Ω", 
    "–§—Ä–∞–Ω–∫—ñ–≤—Å—å–∫–∏–π —Ä–∞–π–æ–Ω", 
    "–®–µ–≤—á–µ–Ω–∫—ñ–≤—Å—å–∫–∏–π —Ä–∞–π–æ–Ω"
]
TOP_CATEGORIES = [
    "–ê–≤–∞—Ä—ñ–π–Ω–∞ —Å–∏—Ç—É–∞—Ü—ñ—è –∑ —Å–∏—Å—Ç–µ–º–æ—é –µ–ª–µ–∫—Ç—Ä–æ–ø–æ—Å—Ç–∞—á–∞–Ω–Ω—è —É –∂–∏—Ç–ª–æ–≤–æ–º—É –±—É–¥–∏–Ω–∫—É", 
    "–ü–æ—Ä—É—à–µ–Ω–Ω—è –ø—Ä–∞–≤–∏–ª –ø–∞—Ä–∫—É–≤–∞–Ω–Ω—è",
    "–ü–∏—Ç–∞–Ω–Ω—è –æ–ø–ª–∞—Ç–∏ —Ç–∞ –Ω–∞–¥–∞–Ω–Ω—è –ø–æ—Å–ª—É–≥",
    "–ù–µ—Å–ø—Ä–∞–≤–Ω–∏–π (–∑—É–ø–∏–Ω–µ–Ω–∏–π) –ª—ñ—Ñ—Ç –∂–∏—Ç–ª–æ–≤–æ–≥–æ –±—É–¥–∏–Ω–∫—É",
    "–í—ñ–¥—Å—É—Ç–Ω—è –ø–æ–¥–∞—á–∞ —Ö–æ–ª–æ–¥–Ω–æ—ó –≤–æ–¥–∏ —É –∂–∏—Ç–ª–æ–≤–æ–º—É –±—É–¥–∏–Ω–∫—É",
    "–°–∫–∞—Ä–≥–∞ –Ω–∞ –∫–æ–º—É–Ω–∞–ª—å–Ω—ñ –ø—ñ–¥–ø—Ä–∏—î–º—Å—Ç–≤–∞",
    "–ü–æ—Ä—É—à–µ–Ω–Ω—è –≥—Ä–∞—Ñ—ñ–∫—É —Ä—É—Ö—É –≥—Ä–æ–º–∞–¥—Å—å–∫–æ–≥–æ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç—É",
    "–Ø–º–∏, –≤–∏–±–æ—ó–Ω–∏ –≤ –∞—Å—Ñ–∞–ª—å—Ç–æ–≤–æ–º—É –ø–æ–∫—Ä–∏—Ç—Ç—ñ –ø—Ä–æ—ó–∂–¥–∂–æ—ó —á–∞—Å—Ç–∏–Ω–∏",
    "–í—ñ–¥—Å—É—Ç–Ω—î –≥–∞—Ä—è—á–µ –≤–æ–¥–æ–ø–æ—Å—Ç–∞—á–∞–Ω–Ω—è (–Ω–µ–¥–∞–≤–Ω–æ) –∂–∏—Ç–ª–æ–≤–æ–≥–æ –±—É–¥–∏–Ω–∫—É",
    "–Ü–Ω—à—ñ –ø–æ—Ä—É—à–µ–Ω–Ω—è –ø—Ä–∞–≤–∏–ª –ø–µ—Ä–µ–≤–µ–∑–µ–Ω–Ω—è –≥—Ä–æ–º–∞–¥—Å—å–∫–∏–º —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–æ–º",
    "–ó–∞—Å—Ç—Ä—è–≥–∞–Ω–Ω—è –∫–∞–±—ñ–Ω–∏ –ª—ñ—Ñ—Ç–∞",
    "–ê–≤–∞—Ä—ñ–π–Ω–∞ —Å–∏—Ç—É–∞—Ü—ñ—è –∑ —Å–∏—Å—Ç–µ–º–æ—é –µ–ª–µ–∫—Ç—Ä–æ–ø–æ—Å—Ç–∞—á–∞–Ω–Ω—è —É –∫–≤–∞—Ä—Ç–∏—Ä—ñ",
    "–Ü–Ω—à—ñ –ø—Ä–æ–±–ª–µ–º–∏ –∑ –ø–æ—Ä—è–¥–∫–æ–º –Ω–∞ –¥–æ—Ä–æ–≥–∞—Ö —Ç–∞ –≥—Ä–æ–º–∞–¥—Å—å–∫–∏—Ö —Ç–µ—Ä–∏—Ç–æ—Ä—ñ—è—Ö",
    "–í–æ–¥—ñ–π –ø—Ä–æ—ñ–≥–Ω–æ—Ä—É–≤–∞–≤ –∑—É–ø–∏–Ω–∫—É –≥—Ä–æ–º–∞–¥—Å—å–∫–æ–≥–æ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç—É",
    "–í—ñ–¥—Å—É—Ç–Ω—î –æ–ø–∞–ª–µ–Ω–Ω—è –ø–æ —Å—Ç–æ—è–∫—É –∂–∏—Ç–ª–æ–≤–æ–≥–æ –±—É–¥–∏–Ω–∫—É",
    "–í—ñ–¥—Å—É—Ç–Ω—î –æ–ø–∞–ª–µ–Ω–Ω—è –ø–æ –∂–∏—Ç–ª–æ–≤–æ–º—É –±—É–¥–∏–Ω–∫—É",
    "–í—ñ–¥—Å—É—Ç–Ω—î –∑–æ–≤–Ω—ñ—à–Ω—î –æ—Å–≤—ñ—Ç–ª–µ–Ω–Ω—è",
    "–Ü–Ω—à—ñ –ø—Ä–æ–±–ª–µ–º–∏ –ø–æ –æ–±—Å–ª—É–≥–æ–≤—É–≤–∞–Ω–Ω—é –±—É–¥–∏–Ω–∫—É",
    "–ü—Ä–æ—Ä–∏–≤ –≤–æ–¥–æ–ø—Ä–æ–≤—ñ–¥–Ω–∏—Ö –º–µ—Ä–µ–∂ (–≤–∏—Ç—ñ–∫ –Ω–∞ –≤—É–ª–∏—Ü—ñ)",
    "–ù–µ –ø—Ä–∏–±—Ä–∞–Ω–∞ –ø—Ä–∏–±—É–¥–∏–Ω–∫–æ–≤–∞ —Ç–µ—Ä–∏—Ç–æ—Ä—ñ—è –≤—ñ–¥ —Å–º—ñ—Ç—Ç—è —á–∏ –ª–∏—Å—Ç—è"


]
OTHER_CATEGORY = "–Ü–Ω—à–µ (–≤–≤–µ—Å—Ç–∏ –≤—Ä—É—á–Ω—É)"

def fetch_and_display_results(payload):
    """Fetches predictions and actuals, then displays them."""
    try:
        # --- Get Prediction ---
        predict_response = requests.post(PREDICT_API_URL, data=json.dumps(payload))
        predict_response.raise_for_status()
        predictions = predict_response.json().get("predictions", {})

        st.subheader("ü§ñ –†–µ–∑—É–ª—å—Ç–∞—Ç–∏ –ø—Ä–æ–≥–Ω–æ–∑—É (–¥–Ω—ñ–≤ –¥–æ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è)")
        cols = st.columns(len(predictions))
        max_days, model_with_max_days = 0, ""

        for idx, (model_name, days) in enumerate(predictions.items()):
            with cols[idx]:
                st.metric(label=model_name, value=f"{days:.1f} –¥–Ω—ñ–≤")
            if days > max_days:
                max_days = days
                model_with_max_days = model_name
        
        st.success(f"**–ë–µ–∑–ø–µ—á–Ω–∞ –æ—Ü—ñ–Ω–∫–∞:** –ù–∞–π–±—ñ–ª—å—à –ø–µ—Å–∏–º—ñ—Å—Ç–∏—á–Ω–∏–π –ø—Ä–æ–≥–Ω–æ–∑ ({model_with_max_days}) —Å—Ç–∞–Ω–æ–≤–∏—Ç—å **{max_days:.1f} –¥–Ω—ñ–≤**.", icon="üõ°Ô∏è")

        # --- Get Actual Case ---
        actual_response = requests.post(ACTUAL_API_URL, data=json.dumps(payload))
        actual_response.raise_for_status()
        actual_data = actual_response.json()
        actual_days = actual_data.get("actual_days")

        if actual_days is not None:
            st.info(f"**–î–ª—è –¥–æ–≤—ñ–¥–∫–∏:** –í–∏–ø–∞–¥–∫–æ–≤–∏–π —Ä–µ–∞–ª—å–Ω–∏–π –≤–∏–ø–∞–¥–æ–∫ –∑ —Ç–∞–∫–∏–º–∏ –∂ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ –±—É–ª–æ –≤–∏—Ä—ñ—à–µ–Ω–æ –∑–∞ **{int(actual_days)} –¥–Ω—ñ–≤**.", icon="üìö")
        else:
            st.warning("–ù–µ –∑–Ω–∞–π–¥–µ–Ω–æ —Ä–µ–∞–ª—å–Ω–∏—Ö —ñ—Å—Ç–æ—Ä–∏—á–Ω–∏—Ö –≤–∏–ø–∞–¥–∫—ñ–≤ –¥–ª—è –ø–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è.", icon="‚ö†Ô∏è")

    except requests.exceptions.RequestException as e:
        st.error(f"–ù–µ –≤–¥–∞–ª–æ—Å—è –ø—ñ–¥–∫–ª—é—á–∏—Ç–∏—Å—è –¥–æ —Å–µ—Ä–≤—ñ—Å—É –º–æ–¥–µ–ª–µ–π. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ, —á–∏ –≤—ñ–Ω –∑–∞–ø—É—â–µ–Ω–∏–π. –ü–æ–º–∏–ª–∫–∞: {e}")
    except Exception as e:
        st.error(f"–°—Ç–∞–ª–∞—Å—è –Ω–µ–æ—á—ñ–∫—É–≤–∞–Ω–∞ –ø–æ–º–∏–ª–∫–∞: {e}")

# --- Main App ---
def predict_page():
    st.title("Lviv City Pulse: –ü—Ä–æ–≥–Ω–æ–∑ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –∑–≤–µ—Ä–Ω–µ–Ω—å")
    st.markdown("–í–≤–µ–¥—ñ—Ç—å –¥–µ—Ç–∞–ª—ñ –≤–∞—à–æ–≥–æ –∑–≤–µ—Ä–Ω–µ–Ω–Ω—è, —â–æ–± –æ—Ç—Ä–∏–º–∞—Ç–∏ –ø—Ä–æ–≥–Ω–æ–∑–Ω–∏–π —á–∞—Å –π–æ–≥–æ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è.")

    with st.form("prediction_form"):
        st.subheader("–î–µ—Ç–∞–ª—ñ –∑–≤–µ—Ä–Ω–µ–Ω–Ω—è")
        district = st.selectbox("–û–±–µ—Ä—ñ—Ç—å —Ä–∞–π–æ–Ω:", DISTRICTS)
        category_choice = st.selectbox("–û–±–µ—Ä—ñ—Ç—å –∫–∞—Ç–µ–≥–æ—Ä—ñ—é:", TOP_CATEGORIES + [OTHER_CATEGORY])
        
        custom_category = ""
        if category_choice == OTHER_CATEGORY:
            custom_category = st.text_input("–í–≤–µ–¥—ñ—Ç—å –≤–∞—à—É –∫–∞—Ç–µ–≥–æ—Ä—ñ—é:")

        submitted = st.form_submit_button("–û—Ç—Ä–∏–º–∞—Ç–∏ –ø—Ä–æ–≥–Ω–æ–∑")

    if submitted:
        final_category = custom_category if category_choice == OTHER_CATEGORY else category_choice
        if not final_category:
            st.warning("–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–≤–µ–¥—ñ—Ç—å –∞–±–æ –æ–±–µ—Ä—ñ—Ç—å –∫–∞—Ç–µ–≥–æ—Ä—ñ—é.")
            return

        payload = {"district": district, "category": final_category}
        with st.spinner("–û—Ç—Ä–∏–º—É—î–º–æ –ø—Ä–æ–≥–Ω–æ–∑ —Ç–∞ —à—É–∫–∞—î–º–æ —Å—Ö–æ–∂—ñ –≤–∏–ø–∞–¥–∫–∏..."):
            fetch_and_display_results(payload)

def about_page():
    st.title("–ü—Ä–æ –ø—Ä–æ–µ–∫—Ç")
    st.markdown("""
    **Lviv City Pulse** - —Ü–µ –ø–æ—Ä—Ç—Ñ–µ–ª—å–Ω–∏–π –ø—Ä–æ–µ–∫—Ç, —Ä–æ–∑—Ä–æ–±–ª–µ–Ω–∏–π –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü—ñ—ó –Ω–∞–≤–∏—á–æ–∫ –≤ MLOps —Ç–∞ –∞—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä—ñ –ø—Ä–æ–≥—Ä–∞–º–Ω–æ–≥–æ –∑–∞–±–µ–∑–ø–µ—á–µ–Ω–Ω—è.
    
    ### –ê—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∞
    –°–∏—Å—Ç–µ–º–∞ –ø–æ–±—É–¥–æ–≤–∞–Ω–∞ –Ω–∞ –æ—Å–Ω–æ–≤—ñ –º—ñ–∫—Ä–æ—Å–µ—Ä–≤—ñ—Å–Ω–æ—ó –∞—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∏ –∑ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è–º Docker —Ç–∞ —Å–∫–ª–∞–¥–∞—î—Ç—å—Å—è –∑ —Ç—Ä—å–æ—Ö –æ—Å–Ω–æ–≤–Ω–∏—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ñ–≤:
    1.  **–ë–∞–∑–∞ –¥–∞–Ω–∏—Ö (PostgreSQL):** –ó–±–µ—Ä—ñ–≥–∞—î —ñ—Å—Ç–æ—Ä–∏—á–Ω—ñ –¥–∞–Ω—ñ –ø—Ä–æ –∑–≤–µ—Ä–Ω–µ–Ω–Ω—è –≥—Ä–æ–º–∞–¥—è–Ω.
    2.  **–°–µ—Ä–≤—ñ—Å –º–æ–¥–µ–ª–µ–π (Python + FastAPI):** –ù–∞–¥–∞—î API –¥–ª—è —Ç—Ä–µ–Ω—É–≤–∞–Ω–Ω—è –º–æ–¥–µ–ª–µ–π —Ç–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –ø—Ä–æ–≥–Ω–æ–∑—ñ–≤. –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î Linear Regression, Random Forest, —Ç–∞ XGBoost.
    3.  **–Ü–Ω—Ç–µ—Ä—Ñ–µ–π—Å (Python + Streamlit):** –¶–µ–π –≤–µ–±-–¥–æ–¥–∞—Ç–æ–∫, —è–∫–∏–π –≤–∏ –∑–∞—Ä–∞–∑ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç–µ –¥–ª—è –≤–∑–∞—î–º–æ–¥—ñ—ó –∑ —Å–∏—Å—Ç–µ–º–æ—é.

    ### –ú–µ—Ç–∞
    –ü—Ä–æ–≥–Ω–æ–∑—É–≤–∞–Ω–Ω—è —á–∞—Å—É, –Ω–µ–æ–±—Ö—ñ–¥–Ω–æ–≥–æ –¥–ª—è –≤–∏—Ä—ñ—à–µ–Ω–Ω—è –∑–≤–µ—Ä–Ω–µ–Ω—å –≥—Ä–æ–º–∞–¥—è–Ω –¥–æ —Å–ª—É–∂–±–∏ 1580 —É –õ—å–≤–æ–≤—ñ, –Ω–∞ –æ—Å–Ω–æ–≤—ñ –≤—ñ–¥–∫—Ä–∏—Ç–∏—Ö –¥–∞–Ω–∏—Ö.
    """)

# --- Sidebar Navigation ---
st.sidebar.title("–ù–∞–≤—ñ–≥–∞—Ü—ñ—è")
page = st.sidebar.radio("–û–±–µ—Ä—ñ—Ç—å —Å—Ç–æ—Ä—ñ–Ω–∫—É", ["–ü—Ä–æ–≥–Ω–æ–∑", "–ü—Ä–æ –ø—Ä–æ–µ–∫—Ç"])

if page == "–ü—Ä–æ–≥–Ω–æ–∑":
    predict_page()
else:
    about_page()
